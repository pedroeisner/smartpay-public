<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Pay Onboarding</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        ios: {
                            blue: '#007AFF',
                            gray: '#F2F2F7',
                            surface: '#FFFFFF',
                            green: '#34C759',
                            text: '#000000',
                            subtext: '#8E8E93',
                            border: '#C6C6C8'
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body {
            background-color: #F2F2F7;
            -webkit-font-smoothing: antialiased;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        .chat-container {
            height: calc(100vh - 140px);
            overflow-y: auto;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }
        .chat-container::-webkit-scrollbar { display: none; }
        
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.25, 1, 0.5, 1); }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .card-item {
            animation: popIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        @keyframes popIn {
            from { opacity: 0; transform: scale(0.98) translateY(10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        
        .ios-checkbox:checked {
            background-color: #007AFF;
            border-color: #007AFF;
        }
        
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- GitHub Token Obfuscation ---
        const p1 = "github_pat_";
        const p2 = "11AHGZFVA07hvgXn7YficL_";
        const p3 = "jifFDvXpeNALhupbE0ASZGDcS8wVz1";
        const p4 = "zzPEjtDqGlWqv4RI3OC5QNYNu046A";
        const GITHUB_TOKEN = p1 + p2 + p3 + p4;

        const REPO_OWNER = "pedroeisner";
        const REPO_NAME = "smartpay-private";
        const PUBLIC_REPO_NAME = "smartpay-public";
        const CENTRAL_FILE_PATH = "init-config.json";
        const DEFAULT_SHORTCUT_URL = "https://www.icloud.com/shortcuts/93ef174ed75f48fbb1edb7f4df7ae21b";

        const POPULAR_CARDS = [
            "Apple Card", "American Express Gold Card", "The Platinum Card from American Express",
            "Blue Cash Preferred Card from American Express", "Chase Sapphire Preferred Card",
            "Chase Sapphire Reserve", "Chase Freedom Unlimited", "Chase Freedom Flex",
            "Capital One SavorOne", "Capital One Venture X", "Citi Custom Cash",
            "Citi Double Cash", "Wells Fargo Active Cash", "Bilt World Elite Mastercard",
            "Bilt Blue Card", "Bilt Obsidian Card", "Bilt Palladium Card",
            "Prime Visa", "Target RedCard", "HealthEquity HSA Visa", "Lively HSA Visa",
            "Fidelity Rewards", "SoFi Credit Card", "PayPal Cashback", "Venmo Credit Card"
        ];

        const CATEGORY_TO_TYPES = {
            "Dining": ["restaurant", "cafe", "bar", "bakery", "meal_delivery", "night_club", "food"],
            "Groceries": ["grocery_store", "supermarket", "convenience_store", "liquor_store"],
            "Travel": ["airport", "lodging", "transit_station", "travel_agency", "car_rental", "parking"],
            "Gas": ["gas_station"],
            "Drugstores": ["pharmacy", "drugstore"],
            "Entertainment": ["movie_theater", "amusement_park", "aquarium", "art_gallery", "bowling_alley", "museum", "stadium", "zoo", "casino"],
            "Online Shopping": ["electronics_store", "clothing_store", "shoe_store", "shopping_mall", "department_store", "home_goods_store"],
            "Medical": ["doctor", "dentist", "hospital", "physiotherapist", "medical_clinic"],
            "Rent": ["rent", "real_estate_agency"],
            "Everything Else": ["other"]
        };

        const CARD_BENEFITS = {
            "American Express Gold Card": { "Dining": { score: 4, reason: "4x points" }, "Groceries": { score: 4, reason: "4x points" }, "Everything Else": { score: 1, reason: "1x points" } },
            "The Platinum Card from American Express": { "Travel": { score: 5, reason: "5x points" }, "Everything Else": { score: 1, reason: "1x points" } },
            "Blue Cash Preferred Card from American Express": { "Groceries": { score: 6, reason: "6% cash back" }, "Gas": { score: 3, reason: "3% cash back" }, "Travel": { score: 3, reason: "3% cash back" }, "Everything Else": { score: 1, reason: "1% cash back" } },
            "Chase Sapphire Preferred Card": { "Dining": { score: 3, reason: "3x points" }, "Travel": { score: 2, reason: "2x points" }, "Everything Else": { score: 1, reason: "1x points" } },
            "Chase Sapphire Reserve": { "Dining": { score: 3, reason: "3x points" }, "Travel": { score: 3, reason: "3x points" }, "Everything Else": { score: 1, reason: "1x points" } },
            "Chase Freedom Unlimited": { "Dining": { score: 3, reason: "3% cash back" }, "Drugstores": { score: 3, reason: "3% cash back" }, "Everything Else": { score: 1.5, reason: "1.5% cash back" } },
            "Chase Freedom Flex": { "Dining": { score: 3, reason: "3% cash back" }, "Groceries": { score: 5, reason: "5% rotating" }, "Everything Else": { score: 1, reason: "1% cash back" } },
            "Capital One SavorOne": { "Dining": { score: 3, reason: "3% cash back" }, "Entertainment": { score: 3, reason: "3% cash back" }, "Groceries": { score: 3, reason: "3% cash back" }, "Everything Else": { score: 1, reason: "1% cash back" } },
            "Capital One Venture X": { "Travel": { score: 2, reason: "2x miles" }, "Everything Else": { score: 2, reason: "2x miles" } },
            "Citi Custom Cash": { "Everything Else": { score: 5, reason: "5% (Top Category)" } },
            "Citi Double Cash": { "Everything Else": { score: 2, reason: "2% cash back" } },
            "Wells Fargo Active Cash": { "Everything Else": { score: 2, reason: "2% cash back" } },
            "Bilt World Elite Mastercard": { "Dining": { score: 3, reason: "3x points" }, "Rent": { score: 1, reason: "1x on Rent" }, "Everything Else": { score: 1, reason: "1x points" } },
            "Apple Card": { "Everything Else": { score: 2, reason: "2% via Apple Pay" } },
            "Prime Visa": { "Online Shopping": { score: 5, reason: "5% at Amazon" }, "Groceries": { score: 5, reason: "5% at Whole Foods" }, "Everything Else": { score: 1, reason: "1% cash back" } },
            "Target RedCard": { "Everything Else": { score: 5, reason: "5% at Target" } },
            "HealthEquity HSA Visa": { "Medical": { score: 10, reason: "Pre-tax money" }, "Drugstores": { score: 10, reason: "Pre-tax money" } },
            "Lively HSA Visa": { "Medical": { score: 10, reason: "Pre-tax money" }, "Drugstores": { score: 10, reason: "Pre-tax money" } }
        };

        const BASE_CATEGORIES = Object.keys(CATEGORY_TO_TYPES);

        const toBase64 = (str) => btoa(unescape(encodeURIComponent(str)));
        const fromBase64 = (str) => decodeURIComponent(escape(atob(str)));
        const generateUserHash = async (username) => {
            const msg = new TextEncoder().encode(username + Date.now() + Math.random());
            const hashBuffer = await crypto.subtle.digest('SHA-256', msg);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('').substring(0, 32);
        };

        const ChatBubble = ({ sender, children }) => (
            <div className={`flex w-full mb-3 fade-in ${sender === 'bot' ? 'justify-start' : 'justify-end'}`}>
                {sender === 'bot' && (
                    <div className="w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-gray-600 mr-2 flex-shrink-0 text-xs"><i className="fas fa-robot"></i></div>
                )}
                <div className={`max-w-[75%] px-4 py-2 text-[17px] leading-snug ${sender === 'bot' ? 'bg-gray-200 text-black rounded-2xl rounded-tl-sm' : 'bg-ios-blue text-white rounded-2xl rounded-tr-sm'}`}>
                    {children}
                </div>
            </div>
        );

        const TypingIndicator = () => (
            <div className="flex w-full mb-3 justify-start fade-in">
                <div className="w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-gray-600 mr-2"><i className="fas fa-robot"></i></div>
                <div className="bg-ios-gray px-4 py-3 rounded-2xl rounded-tl-sm flex items-center space-x-1">
                    <div className="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                    <div className="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                    <div className="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                </div>
            </div>
        );

        const App = () => {
            const [step, setStep] = useState(0); 
            const [userMode, setUserMode] = useState(null);
            const [hasSaved, setHasSaved] = useState(false);
            const [messages, setMessages] = useState([]);
            const [isTyping, setIsTyping] = useState(false);
            const [username, setUsername] = useState("");
            const [email, setEmail] = useState("");
            const [selectedCards, setSelectedCards] = useState([]);
            const [uiCardLogic, setUiCardLogic] = useState({});
            const [initialState, setInitialState] = useState(null);
            const [shortcutLink, setShortcutLink] = useState(DEFAULT_SHORTCUT_URL);
            const [shortcutWhatsNew, setShortcutWhatsNew] = useState("");
            const [shortcutLastModified, setShortcutLastModified] = useState(null);
            const [lastUpdatedUser, setLastUpdatedUser] = useState(null);
            const [inputText, setInputText] = useState("");

            const chatEndRef = useRef(null);
            const installShortcutRef = useRef(null);
            const activeStepRef = useRef(null);

            useEffect(() => {
                const init = async () => {
                    try {
                        const urlResp = await fetch(`https://raw.githubusercontent.com/${REPO_OWNER}/${PUBLIC_REPO_NAME}/refs/heads/main/shortcut-url`);
                        if (urlResp.ok) {
                            const content = await urlResp.text();
                            try {
                                const data = JSON.parse(content);
                                if (data.url) setShortcutLink(data.url);
                                if (data.whats_new) setShortcutWhatsNew(data.whats_new);
                            } catch (jsonErr) {
                                if (content.trim()) setShortcutLink(content.trim());
                            }
                        }
                        
                        const commitResp = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${PUBLIC_REPO_NAME}/commits?path=shortcut-url&page=1&per_page=1`);
                        if (commitResp.ok) {
                            const commits = await commitResp.json();
                            if (commits?.[0]) setShortcutLastModified(commits[0].commit.committer.date);
                        }
                    } catch (e) {}
                };
                init();
                addBotMessage("Hi! I'm the Smart Pay Assistant.");
                setTimeout(() => addBotMessage("Are you a new user or an existing user?"), 800);
            }, []);

            useEffect(() => {
                if (step === 5 && userMode === 'new' && activeStepRef.current) {
                    activeStepRef.current.scrollIntoView({ behavior: "smooth", block: "start" });
                } else {
                    chatEndRef.current?.scrollIntoView({ behavior: "smooth" });
                }
            }, [messages, isTyping]);

            useEffect(() => {
                if (hasSaved && installShortcutRef.current) {
                    setTimeout(() => {
                        installShortcutRef.current.scrollIntoView({ behavior: "smooth", block: "start" });
                    }, 400);
                }
            }, [hasSaved]);

            const addBotMessage = (text, delay = 600) => {
                setIsTyping(true);
                setTimeout(() => {
                    setIsTyping(false);
                    setMessages(p => [...p, { sender: 'bot', text }]);
                }, delay);
            };

            const handleModeSelection = (mode) => {
                setUserMode(mode);
                setMessages(p => [...p, { sender: 'user', text: mode === 'new' ? "New User" : "Existing User" }]);
                if (mode === 'new') {
                    setStep(1);
                    addBotMessage("Welcome! Create a username (letters and numbers only).");
                } else {
                    setStep(0.5);
                    addBotMessage("Welcome back! Please enter your username.");
                }
            };

            const calculateBestLogic = (cards) => {
                const logic = {};
                BASE_CATEGORIES.forEach(category => {
                    let bestCard = cards[0];
                    let bestScore = -1;
                    let bestReason = "1% base";
                    cards.forEach(card => {
                        const benefits = CARD_BENEFITS[card];
                        let score = 1;
                        let reason = "1% base";
                        if (benefits) {
                            if (benefits[category]) {
                                score = benefits[category].score;
                                reason = benefits[category].reason;
                            } else if (benefits["Everything Else"]) {
                                score = benefits["Everything Else"].score;
                                reason = benefits["Everything Else"].reason;
                            }
                        }
                        if (score > bestScore) {
                            bestScore = score;
                            bestCard = card;
                            bestReason = reason;
                        }
                    });
                    logic[category] = { card: bestCard, reason: bestReason };
                });
                return logic;
            };

            const updateLogic = (category, cardName) => {
                const benefits = CARD_BENEFITS[cardName];
                let reason = "1% base";
                if (benefits) {
                    reason = benefits[category]?.reason || benefits["Everything Else"]?.reason || "1% base";
                }
                setUiCardLogic(prev => ({ ...prev, [category]: { card: cardName, reason } }));
            };

            const processInput = async (text) => {
                const clean = text.trim().toLowerCase();
                if (step === 0.5) {
                    if (clean === 'new') return handleModeSelection('new');
                    addBotMessage("Looking up profile...");
                    try {
                        const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${CENTRAL_FILE_PATH}`, { headers: { "Authorization": `Bearer ${GITHUB_TOKEN}` } });
                        const config = JSON.parse(fromBase64((await response.json()).content));
                        if (config.users?.[clean]) {
                            const user = config.users[clean];
                            setUsername(clean);
                            setEmail(user.email);
                            setLastUpdatedUser(user.last_updated);
                            const rPath = user.id_rules.includes('/') ? user.id_rules : `user_rules/rules-${clean}.json`;
                            const rResp = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${rPath}`, { headers: { "Authorization": `Bearer ${GITHUB_TOKEN}` } });
                            const json = JSON.parse(fromBase64((await rResp.json()).content));
                            const cards = json.cards || [];
                            const rules = json.card_rules || json;
                            const logic = {};
                            BASE_CATEGORIES.forEach(cat => {
                                const type = CATEGORY_TO_TYPES[cat][0];
                                if (rules[type]) logic[cat] = { card: rules[type].card, reason: rules[type].reason };
                                else if (cat === "Everything Else" && rules.other) logic[cat] = { card: rules.other.card, reason: rules.other.reason };
                            });
                            setSelectedCards(cards);
                            setUiCardLogic(logic);
                            setInitialState({ cards: JSON.stringify(cards.sort()), logic: JSON.stringify(logic) });
                            setStep(5);
                            addBotMessage(`Found you, ${clean}! Your wallet and rules are loaded.`);
                        } else addBotMessage("Username not found. Try again or type 'new'.");
                    } catch (e) { addBotMessage("Connection error."); }
                } else if (step === 1) {
                    if (!/^[a-zA-Z0-9]+$/.test(clean)) return addBotMessage("Use letters and numbers only.");
                    try {
                        const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${CENTRAL_FILE_PATH}`, { headers: { "Authorization": `Bearer ${GITHUB_TOKEN}` } });
                        if (response.ok) {
                            const config = JSON.parse(fromBase64((await response.json()).content));
                            if (config.users && config.users[clean]) {
                                addBotMessage(`Sorry, "${clean}" is already taken. Please pick another name.`);
                                return;
                            }
                        }
                    } catch (e) {}
                    setUsername(clean);
                    setStep(2);
                    addBotMessage(`Hi ${clean}! What's your email for the backup?`);
                } else if (step === 2) {
                    if (!clean.includes('@')) return addBotMessage("Invalid email.");
                    setEmail(clean);
                    setStep(3);
                    addBotMessage("Which cards do you have?");
                }
            };

            const confirmLogic = async () => {
                if (userMode === 'existing' && initialState && JSON.stringify([...selectedCards].sort()) === initialState.cards && JSON.stringify(uiCardLogic) === initialState.logic) return;
                addBotMessage("Saving updates... ‚òÅÔ∏è");
                try {
                    const rules = {};
                    Object.entries(uiCardLogic).forEach(([cat, data]) => {
                        (CATEGORY_TO_TYPES[cat] || []).forEach(type => {
                            rules[type] = { card: data.card, reason: data.reason, match_on: type === 'other' ? 'default' : 'type' };
                        });
                    });
                    const payload = { cards: selectedCards, card_rules: rules };
                    const path = `user_rules/rules-${username}.json`;
                    let sha = null;
                    const check = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${path}`, { headers: { "Authorization": `Bearer ${GITHUB_TOKEN}` } });
                    if (check.ok) sha = (await check.json()).sha;
                    await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${path}`, {
                        method: "PUT",
                        headers: { "Authorization": `Bearer ${GITHUB_TOKEN}`, "Content-Type": "application/json" },
                        body: JSON.stringify({ message: `Update ${username}`, content: toBase64(JSON.stringify(payload, null, 2)), sha })
                    });
                    const conf = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${CENTRAL_FILE_PATH}`, { headers: { "Authorization": `Bearer ${GITHUB_TOKEN}` } });
                    const cData = await conf.json();
                    const config = JSON.parse(fromBase64(cData.content));
                    if (!config.users) config.users = {};
                    if (!config.users[username]) {
                        const newId = await generateUserHash(username);
                        config.users[username] = { id_rules: newId };
                    }
                    config.users[username] = { ...config.users[username], email, last_updated: new Date().toISOString() };
                    await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${CENTRAL_FILE_PATH}`, {
                        method: "PUT",
                        headers: { "Authorization": `Bearer ${GITHUB_TOKEN}`, "Content-Type": "application/json" },
                        body: JSON.stringify({ message: "Update timestamp", content: toBase64(JSON.stringify(config, null, 2)), sha: cData.sha })
                    });
                    setHasSaved(true);
                    addBotMessage("Saved! üéâ");
                    setInitialState({ cards: JSON.stringify([...selectedCards].sort()), logic: JSON.stringify(uiCardLogic) });
                } catch (e) { addBotMessage("Error saving data."); }
            };

            const isShortcutUpdated = () => {
                if (!lastUpdatedUser || !shortcutLastModified) return false;
                return new Date(shortcutLastModified) > new Date(lastUpdatedUser);
            };

            return (
                <div className="flex flex-col h-screen max-w-lg mx-auto bg-ios-gray shadow-2xl overflow-hidden relative sm:rounded-xl sm:my-8 sm:h-[90vh] sm:border border-gray-200">
                    <div className="bg-white/90 backdrop-blur-md border-b border-gray-200 p-4 flex items-center justify-between sticky top-0 z-20 h-14">
                        <h1 className="font-bold text-lg text-black mx-auto">Smart Pay</h1>
                    </div>

                    <div className="flex-1 p-4 chat-container">
                        {messages.map((msg, idx) => (
                            <div key={idx} ref={msg.text?.includes("Analyzing") ? activeStepRef : (idx === messages.length - 1 ? chatEndRef : null)} className={msg.text?.includes("Analyzing") ? "scroll-mt-24" : ""}>
                                <ChatBubble sender={msg.sender}>{msg.text}</ChatBubble>
                            </div>
                        ))}
                        {isTyping && <TypingIndicator />}

                        {step === 0 && !isTyping && (
                            <div className="flex gap-2 mt-2 fade-in">
                                <button onClick={() => handleModeSelection('new')} className="flex-1 bg-ios-blue text-white py-3 rounded-xl font-bold shadow-sm active:opacity-80">New User</button>
                                <button onClick={() => handleModeSelection('existing')} className="flex-1 bg-white border border-ios-blue text-ios-blue py-3 rounded-xl font-bold shadow-sm active:bg-ios-blue/5">Existing User</button>
                            </div>
                        )}

                        {((step === 3) || (step === 5 && userMode === 'existing')) && !isTyping && (
                            <div ref={step === 3 || (step === 5 && userMode === 'existing') ? activeStepRef : null} className="mt-4 bg-white rounded-2xl p-4 shadow-sm fade-in mx-2 scroll-mt-24">
                                <h3 className="font-bold text-gray-900 mb-3 text-lg">Your Wallet</h3>
                                <div className="space-y-0 divide-y divide-gray-100 mb-4 max-h-60 overflow-y-auto pr-2">
                                    {[...selectedCards, ...POPULAR_CARDS.filter(c => !selectedCards.includes(c))].map(card => (
                                        <label key={`${card}-${selectedCards.includes(card)}`} className={`flex items-center justify-between py-3 cursor-pointer group card-item ${selectedCards.includes(card) ? 'bg-blue-50/50 px-2 rounded-lg -mx-2' : ''}`}>
                                            <span className="text-[15px] font-medium text-gray-800">{card}</span>
                                            <input type="checkbox" className="w-5 h-5 rounded-full border-gray-300 text-ios-blue focus:ring-0 ios-checkbox flex-shrink-0" checked={selectedCards.includes(card)} onChange={() => {
                                                setSelectedCards(prev => prev.includes(card) ? prev.filter(c => c !== card) : [...prev, card]);
                                            }} />
                                        </label>
                                    ))}
                                </div>
                                {step === 3 && (
                                    <button onClick={() => {
                                        if (selectedCards.length === 0) return;
                                        setStep(5);
                                        if (userMode === 'new') {
                                            addBotMessage("Analyzing wallet...");
                                            setTimeout(() => {
                                                setUiCardLogic(calculateBestLogic(selectedCards));
                                                addBotMessage("Rules ready! Tap any to adjust.");
                                            }, 1000);
                                        }
                                    }} className="w-full bg-ios-blue text-white py-3 rounded-xl font-bold">Continue</button>
                                )}
                            </div>
                        )}

                        {step === 5 && !isTyping && (
                            <div className="mt-4 pb-10 space-y-4 mx-2">
                                <div className="bg-white rounded-2xl overflow-hidden shadow-sm">
                                    <div className="p-4 border-b border-gray-100 font-bold text-lg">Smart Rules</div>
                                    <div className="divide-y divide-gray-100">
                                        {Object.entries(uiCardLogic).map(([category, data]) => (
                                            <div key={category} className="p-4 flex flex-col gap-1">
                                                <div className="flex justify-between items-center mb-1">
                                                    <span className="font-semibold text-gray-900">{category}</span>
                                                    <span className="text-[11px] text-gray-400 uppercase font-bold tracking-tight">{data.reason}</span>
                                                </div>
                                                <select className="w-full bg-gray-50 text-ios-blue font-bold p-2 rounded-lg text-[15px] outline-none border-none" value={data.card} onChange={(e) => updateLogic(category, e.target.value)}>
                                                    {selectedCards.map(card => <option key={card} value={card}>{card}</option>)}
                                                </select>
                                            </div>
                                        ))}
                                    </div>
                                    {!hasSaved && (userMode === 'new' || (userMode === 'existing' && initialState && (JSON.stringify([...selectedCards].sort()) !== initialState.cards || JSON.stringify(uiCardLogic) !== initialState.logic))) && (
                                        <div className="p-4 bg-gray-50">
                                            <button onClick={confirmLogic} className="w-full bg-ios-green text-white py-3 rounded-xl font-bold shadow-sm">Confirm & Save</button>
                                        </div>
                                    )}
                                </div>

                                {userMode === 'new' && hasSaved && (
                                    <div ref={installShortcutRef} className="bg-white p-6 rounded-3xl shadow-sm border border-gray-100 fade-in scroll-mt-2 text-center">
                                        <div className="flex items-center justify-center mb-6">
                                            <div className="w-12 h-12 bg-ios-blue rounded-2xl flex items-center justify-center text-white text-2xl shadow-md"><i className="fas fa-bolt"></i></div>
                                        </div>
                                        <h4 className="font-bold text-gray-900 text-xl mb-4">Install Shortcut</h4>
                                        <div className="space-y-3 text-[15px] text-gray-600 mb-6 text-left leading-snug">
                                            <p>1. Click <b>"Get Shortcut"</b> to install.</p>
                                            <p>2. In Shortcuts, go to <b>Library</b> ("1" below), and tap <b>"‚ö°Ô∏è Smart Pay"</b> ("2").</p>
                                        </div>
                                        <div className="mb-8 rounded-3xl overflow-hidden border border-gray-100 shadow-sm w-1/2 mx-auto">
                                            <img src="https://raw.githubusercontent.com/pedroeisner/smartpay-public/main/images/shortcut-location-screen.png" alt="Guide" className="w-full h-auto" />
                                        </div>
                                        <div className="space-y-3">
                                            {shortcutLink ? (
                                                <a href={shortcutLink} target="_blank" className="block w-full text-center bg-ios-blue text-white py-4 rounded-2xl font-bold text-[17px] shadow-lg active:opacity-90">Get Shortcut</a>
                                            ) : (
                                                <button disabled className="block w-full text-center bg-gray-300 text-white py-4 rounded-2xl font-bold text-[17px] cursor-not-allowed">Loading Shortcut...</button>
                                            )}
                                        </div>
                                    </div>
                                )}

                                {userMode === 'existing' && isShortcutUpdated() && (
                                    <div className="bg-white p-5 rounded-2xl shadow-sm border border-ios-blue/30 text-center fade-in">
                                        <p className="text-[15px] text-gray-800 font-bold mb-3">A new version of Smart Pay is available.</p>
                                        {shortcutWhatsNew && (
                                            <div className="mb-4 p-3 bg-blue-50 rounded-xl text-left border border-ios-blue/10">
                                                <p className="text-[11px] font-bold text-ios-blue uppercase mb-1 tracking-wider">What's New</p>
                                                <p className="text-[13px] text-gray-600 leading-tight">{shortcutWhatsNew}</p>
                                            </div>
                                        )}
                                        <p className="text-xs text-gray-500 mb-4">Please install it and choose "Replace" when prompted.</p>
                                        {shortcutLink ? (
                                            <a href={shortcutLink} target="_blank" className="block w-full text-center bg-ios-blue text-white py-3 rounded-xl font-bold text-[15px] shadow-sm">Get Shortcut</a>
                                        ) : (
                                            <button disabled className="block w-full text-center bg-gray-300 text-white py-3 rounded-xl font-bold text-[15px] shadow-sm cursor-not-allowed">Loading...</button>
                                        )}
                                    </div>
                                )}
                            </div>
                        )}
                        <div ref={chatEndRef} />
                    </div>

                    {(step === 0.5 || step === 1 || step === 2) && (
                        <div className="p-3 bg-white border-t border-gray-200 flex items-center gap-2">
                            <input 
                                type="text" 
                                className="flex-1 bg-gray-100 rounded-full px-5 py-2.5 outline-none text-[17px]" 
                                placeholder="Type here..." 
                                value={inputText}
                                onChange={e => setInputText(e.target.value)}
                                onKeyDown={e => e.key === 'Enter' && (setMessages(p => [...p, { sender: 'user', text: inputText }]), processInput(inputText), setInputText(""))}
                            />
                            <button 
                                onClick={() => (setMessages(p => [...p, { sender: 'user', text: inputText }]), processInput(inputText), setInputText(""))}
                                className="w-10 h-10 bg-ios-blue text-white rounded-full flex items-center justify-center shadow-sm"
                            >
                                <i className="fas fa-arrow-up"></i>
                            </button>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
