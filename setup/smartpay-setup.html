<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Pay Onboarding</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        ios: {
                            blue: '#007AFF',
                            gray: '#E9E9EB',
                            bg: '#F2F2F7',
                            surface: '#FFFFFF',
                            green: '#34C759',
                            text: '#000000',
                            subtext: '#8E8E93'
                        }
                    },
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', '"Segoe UI"', 'Roboto', 'Helvetica', 'Arial', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body {
            background-color: #F2F2F7;
            -webkit-font-smoothing: antialiased;
        }
        .chat-container {
            height: calc(100vh - 140px);
            overflow-y: auto;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }
        .chat-container::-webkit-scrollbar {
            display: none;
        }
        .typing-dot {
            animation: typing 1.4s infinite ease-in-out both;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        .fade-in {
            animation: fadeIn 0.4s cubic-bezier(0.25, 1, 0.5, 1);
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Custom Checkbox */
        .ios-checkbox:checked {
            background-color: #007AFF;
            border-color: #007AFF;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Configuration ---
        const GITHUB_TOKEN = "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"; 
        const CENTRAL_GIST_ID = "6826d4a99e1aea18935e3608162dcd1a";
        const CENTRAL_FILE_NAME = "init-config.json";

        // --- Data Lists ---
        const POPULAR_CARDS = [
            "Apple Card",
            "American Express Gold Card",
            "The Platinum Card from American Express",
            "Blue Cash Preferred Card from American Express",
            "Blue Cash Everyday Card from American Express",
            "American Express Green Card",
            "Delta SkyMiles Gold American Express Card",
            "Delta SkyMiles Platinum American Express Card",
            "Delta SkyMiles Reserve American Express Card",
            "Hilton Honors American Express Card",
            "Hilton Honors American Express Surpass Card",
            "Hilton Honors American Express Aspire Card",
            "Marriott Bonvoy Brilliant American Express Card",
            "Marriott Bonvoy Bevy American Express Card",
            "Chase Sapphire Preferred Card",
            "Chase Sapphire Reserve",
            "Chase Freedom Unlimited",
            "Chase Freedom Flex",
            "Ink Business Preferred Credit Card",
            "Ink Business Cash Credit Card",
            "Ink Business Unlimited Credit Card",
            "United Explorer Card",
            "United Quest Card",
            "United Club Infinite Card",
            "Southwest Rapid Rewards Plus Credit Card",
            "Southwest Rapid Rewards Premier Credit Card",
            "Southwest Rapid Rewards Priority Credit Card",
            "British Airways Visa Signature Card",
            "Aeroplan Credit Card",
            "World of Hyatt Credit Card",
            "IHG One Rewards Premier Credit Card",
            "Capital One Venture X Rewards Credit Card",
            "Capital One Venture Rewards Credit Card",
            "Capital One VentureOne Rewards Credit Card",
            "Capital One Quicksilver Cash Rewards Credit Card",
            "Capital One SavorOne Cash Rewards Credit Card",
            "Capital One Savor Cash Rewards Credit Card",
            "Capital One Platinum Credit Card",
            "Citi Double Cash Card",
            "Citi Custom Cash Card",
            "Citi Strata Premier Card",
            "Citi / AAdvantage Platinum Select World Elite Mastercard",
            "Costco Anywhere Visa Card by Citi",
            "Discover it Cash Back",
            "Discover it Miles",
            "Discover it Chrome",
            "Wells Fargo Active Cash Card",
            "Wells Fargo Autograph Card",
            "Bilt World Elite Mastercard",
            "U.S. Bank Altitude Go Visa Signature Card",
            "Prime Visa",
            "Target RedCard",
            "HealthEquity Visa Healthcare Card",
            "Lively HSA Visa Debit",
            "Fidelity Rewards Visa Signature Card",
            "SoFi Credit Card",
            "PayPal Cashback Mastercard",
            "Venmo Credit Card",
            "X1 Card",
            "Gemini Credit Card"
        ];

        const BASE_CATEGORIES = ["Groceries", "Dining", "Travel", "Gas", "Online Shopping", "Drugstores", "Entertainment", "Everything Else"];

        const CATEGORY_TO_TYPES = {
            "Dining": ["restaurant", "cafe", "bar", "bakery", "meal_delivery", "night_club", "food"],
            "Groceries": ["grocery_store", "supermarket", "convenience_store", "liquor_store"],
            "Travel": ["airport", "lodging", "transit_station", "travel_agency", "car_rental", "parking"],
            "Gas": ["gas_station"],
            "Drugstores": ["pharmacy", "drugstore"],
            "Entertainment": ["movie_theater", "amusement_park", "aquarium", "art_gallery", "bowling_alley", "museum", "stadium", "zoo", "casino"],
            "Online Shopping": ["electronics_store", "clothing_store", "shoe_store", "shopping_mall", "department_store", "home_goods_store"],
            "Medical": ["doctor", "dentist", "hospital", "physiotherapist", "medical_clinic"],
            "Rent": ["rent", "real_estate_agency"],
            "Everything Else": ["other"]
        };

        const CARD_BENEFITS = {
            "American Express Gold Card": { "Dining": { score: 4, reason: "4x points" }, "Groceries": { score: 4, reason: "4x points" }, "Travel": { score: 3, reason: "3x points" }, "Everything Else": { score: 1, reason: "1x points" } },
            "The Platinum Card from American Express": { "Travel": { score: 5, reason: "5x points" }, "Dining": { score: 1, reason: "1x points" }, "Everything Else": { score: 1, reason: "1x points" } },
            "Blue Cash Preferred Card from American Express": { "Groceries": { score: 6, reason: "6% cash back" }, "Gas": { score: 3, reason: "3% cash back" }, "Travel": { score: 3, reason: "3% cash back" }, "Everything Else": { score: 1, reason: "1% cash back" } },
            "Chase Sapphire Preferred Card": { "Travel": { score: 2.25, reason: "2x points" }, "Dining": { score: 3, reason: "3x points" }, "Online Shopping": { score: 3, reason: "3x points (online grocery)" }, "Streaming": { score: 3, reason: "3x points" }, "Everything Else": { score: 1, reason: "1x points" } },
            "Chase Sapphire Reserve": { "Travel": { score: 3, reason: "3x points" }, "Dining": { score: 3, reason: "3x points" }, "Everything Else": { score: 1, reason: "1x points" } },
            "Chase Freedom Unlimited": { "Dining": { score: 3, reason: "3% cash back" }, "Drugstores": { score: 3, reason: "3% cash back" }, "Everything Else": { score: 1.5, reason: "1.5% cash back" } },
            "Chase Freedom Flex": { "Dining": { score: 3, reason: "3% cash back" }, "Drugstores": { score: 3, reason: "3% cash back" }, "Travel": { score: 5, reason: "5% on travel" }, "Everything Else": { score: 1, reason: "1% cash back" } },
            "Capital One SavorOne Cash Rewards Credit Card": { "Dining": { score: 3, reason: "3% cash back" }, "Entertainment": { score: 3, reason: "3% cash back" }, "Groceries": { score: 3, reason: "3% cash back" }, "Everything Else": { score: 1, reason: "1% cash back" } },
            "Capital One Venture X Rewards Credit Card": { "Travel": { score: 2, reason: "2x miles" }, "Everything Else": { score: 2, reason: "2x miles" } },
            "Citi Custom Cash Card": { "Groceries": { score: 5, reason: "5% cash back (adaptive)" }, "Gas": { score: 5, reason: "5% cash back (adaptive)" }, "Dining": { score: 5, reason: "5% cash back (adaptive)" }, "Everything Else": { score: 1, reason: "1% cash back" } },
            "Citi Double Cash Card": { "Everything Else": { score: 2, reason: "2% cash back" } },
            "Wells Fargo Active Cash Card": { "Everything Else": { score: 2, reason: "2% cash back" } },
            "Bilt World Elite Mastercard": { "Dining": { score: 3, reason: "3x points" }, "Travel": { score: 2, reason: "2x points" }, "Rent": { score: 1, reason: "1x points on rent" }, "Everything Else": { score: 1, reason: "1x points" } },
            "Apple Card": { "Everything Else": { score: 2, reason: "2% using Apple Pay" } },
            "Prime Visa": { "Online Shopping": { score: 5, reason: "5% at Amazon" }, "Dining": { score: 2, reason: "2% cash back" }, "Gas": { score: 2, reason: "2% cash back" }, "Drugstores": { score: 2, reason: "2% cash back" }, "Everything Else": { score: 1, reason: "1% cash back" } },
            "U.S. Bank Altitude Go Visa Signature Card": { "Dining": { score: 4, reason: "4x points" }, "Groceries": { score: 2, reason: "2x points" }, "Gas": { score: 2, reason: "2x points" }, "Everything Else": { score: 1, reason: "1x points" } },
            "Costco Anywhere Visa Card by Citi": { "Gas": { score: 4, reason: "4% cash back" }, "Dining": { score: 3, reason: "3% cash back" }, "Travel": { score: 3, reason: "3% cash back" }, "Everything Else": { score: 1, reason: "1% cash back" } },
            "Discover it Cash Back": { "Everything Else": { score: 1, reason: "1% cash back" }, "Groceries": { score: 5, reason: "5% rotating" } },
            "Target RedCard": { "Online Shopping": { score: 1, reason: "5% at Target" }, "Groceries": { score: 1, reason: "5% at Target" }, "Everything Else": { score: 1, reason: "1% at Target" } },
            "HealthEquity Visa Healthcare Card": { "Medical": { score: 10, reason: "Pre-tax funds" }, "Drugstores": { score: 10, reason: "Pre-tax funds" }, "Everything Else": { score: 0, reason: "No benefit" } },
            "Lively HSA Visa Debit": { "Medical": { score: 10, reason: "Pre-tax funds" }, "Drugstores": { score: 10, reason: "Pre-tax funds" }, "Everything Else": { score: 0, reason: "No benefit" } },
            "Fidelity Rewards Visa Signature Card": { "Everything Else": { score: 2, reason: "2% cash back" } },
            "SoFi Credit Card": { "Everything Else": { score: 2, reason: "2% cash back" } },
            "PayPal Cashback Mastercard": { "Online Shopping": { score: 3, reason: "3% via PayPal" }, "Everything Else": { score: 1.5, reason: "1.5% cash back" } }
        };

        // --- Logic Utils ---

        // Levenshtein distance for fuzzy matching
        const levenshteinDistance = (a, b) => {
            const matrix = [];
            for (let i = 0; i <= b.length; i++) { matrix[i] = [i]; }
            for (let j = 0; j <= a.length; j++) { matrix[0][j] = j; }
            for (let i = 1; i <= b.length; i++) {
                for (let j = 1; j <= a.length; j++) {
                    if (b.charAt(i - 1) === a.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            return matrix[b.length][a.length];
        };

        const findClosestCard = (input) => {
            const cleanInput = input.trim().toLowerCase();
            let bestMatch = null;
            let lowestDistance = Infinity;
            
            // Threshold: Allow some typos but not too many. ~40% length diff max
            const threshold = Math.max(3, Math.floor(cleanInput.length * 0.4));

            for (const card of POPULAR_CARDS) {
                const dist = levenshteinDistance(cleanInput, card.toLowerCase());
                if (dist < lowestDistance) {
                    lowestDistance = dist;
                    bestMatch = card;
                }
            }
            
            // Heuristic Check: if distance is reasonable, return match.
            if (lowestDistance <= threshold) {
                return bestMatch;
            }
            
            // Fallback: If no close match, verify if user typed "Apple" -> "Apple Card"
            if (cleanInput.includes("apple")) return "Apple Card";
            if (cleanInput.includes("amazon") || cleanInput.includes("prime")) return "Prime Visa";
            if (cleanInput.includes("target")) return "Target RedCard";
            if (cleanInput.includes("bilt")) return "Bilt World Elite Mastercard";

            // If truly unknown, just capitalize input nicely
            return input.trim().replace(/\b\w/g, c => c.toUpperCase());
        };


        // --- UI Components ---

        const ChatBubble = ({ sender, children }) => {
            const isBot = sender === 'bot';
            return (
                <div className={`flex w-full mb-3 fade-in ${isBot ? 'justify-start' : 'justify-end'}`}>
                    {isBot && (
                        <div className="w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-gray-600 mr-2 flex-shrink-0 text-xs">
                            <i className="fas fa-robot"></i>
                        </div>
                    )}
                    <div className={`max-w-[75%] px-4 py-2 text-[17px] leading-snug ${
                        isBot 
                            ? 'bg-ios-gray text-black rounded-2xl rounded-tl-sm' 
                            : 'bg-ios-blue text-white rounded-2xl rounded-tr-sm'
                    }`}>
                        {children}
                    </div>
                </div>
            );
        };

        const TypingIndicator = () => (
            <div className="flex w-full mb-3 justify-start fade-in">
                <div className="w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-gray-600 mr-2">
                    <i className="fas fa-robot"></i>
                </div>
                <div className="bg-ios-gray px-4 py-3 rounded-2xl rounded-tl-sm flex items-center space-x-1">
                    <div className="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                    <div className="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                    <div className="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                </div>
            </div>
        );

        const App = () => {
            const [messages, setMessages] = useState([]);
            const [isTyping, setIsTyping] = useState(false);
            const [step, setStep] = useState(0); 
            const [username, setUsername] = useState("");
            const [email, setEmail] = useState("");
            const [selectedCards, setSelectedCards] = useState([]);
            const [otherCardInput, setOtherCardInput] = useState("");
            const [uiCardLogic, setUiCardLogic] = useState({});
            const [inputText, setInputText] = useState("");
            const chatEndRef = useRef(null);

            useEffect(() => {
                chatEndRef.current?.scrollIntoView({ behavior: "smooth" });
            }, [messages, isTyping]);

            useEffect(() => {
                addBotMessage("Hi! I'm the Smart Pay Assistant.");
                setTimeout(() => {
                    addBotMessage("I'll help you pick the best card for every purchase. üöÄ");
                    setTimeout(() => {
                        addBotMessage("Note: Smart Pay is for iOS only.");
                        setTimeout(() => {
                            askForUsername();
                        }, 1000);
                    }, 1500);
                }, 1000);
            }, []);

            const addBotMessage = (text, delay = 800) => {
                setIsTyping(true);
                setTimeout(() => {
                    setIsTyping(false);
                    setMessages(prev => [...prev, { sender: 'bot', text }]);
                }, delay);
            };

            const addUserMessage = (text) => {
                setMessages(prev => [...prev, { sender: 'user', text }]);
            };

            const handleSend = () => {
                if (!inputText.trim()) return;
                addUserMessage(inputText);
                const text = inputText;
                setInputText("");
                processInput(text);
            };

            const processInput = (text) => {
                if (step === 1) {
                    const cleanName = text.trim();
                    const isValid = /^[a-zA-Z0-9]+$/.test(cleanName);
                    if (!isValid) {
                        addBotMessage("Username must be letters and numbers only.");
                        return;
                    }
                    setUsername(cleanName);
                    setStep(2);
                    addBotMessage(`Hi, ${cleanName}! üëã`);
                    setTimeout(() => addBotMessage("What's your email for the backup?"), 800);
                } else if (step === 2) {
                    if (!text.includes('@') || !text.includes('.')) {
                        addBotMessage("Please enter a valid email.");
                        return;
                    }
                    setEmail(text);
                    setStep(3);
                    addBotMessage("Let's set up your wallet.");
                    setTimeout(() => {
                        addBotMessage("Which cards do you have?");
                        setTimeout(() => {
                            addBotMessage("Note: We only need card names, never numbers.");
                        }, 800);
                    }, 800);
                }
            };

            const askForUsername = () => {
                setStep(1);
                addBotMessage("Create a username (letters/numbers only).");
            };

            const toggleCard = (card) => {
                if (selectedCards.includes(card)) {
                    setSelectedCards(prev => prev.filter(c => c !== card));
                } else {
                    setSelectedCards(prev => [...prev, card]);
                }
            };

            const addOtherCard = () => {
                if (otherCardInput.trim()) {
                    const matched = findClosestCard(otherCardInput);
                    if (!selectedCards.includes(matched)) {
                        setSelectedCards(prev => [...prev, matched]);
                    }
                    setOtherCardInput("");
                }
            };

            const calculateBestLogic = (cards) => {
                const newLogic = {};
                let activeCategories = [...BASE_CATEGORIES];
                
                const hasBilt = cards.some(c => c.includes("Bilt"));
                const hasHSA = cards.some(c => c.includes("HealthEquity") || c.includes("Lively") || c.includes("HSA"));
                
                if (hasBilt) activeCategories.push("Rent");
                if (hasHSA) activeCategories.push("Medical");

                activeCategories.forEach(category => {
                    let bestCard = cards[0];
                    let maxScore = -1;
                    let bestReason = "Default card";

                    cards.forEach(card => {
                        let score = 1;
                        let reason = "1% base value";

                        const benefits = CARD_BENEFITS[card];
                        if (benefits) {
                            if (benefits[category]) {
                                score = benefits[category].score;
                                reason = benefits[category].reason;
                            } else if (benefits["Everything Else"]) {
                                score = benefits["Everything Else"].score;
                                reason = benefits["Everything Else"].reason;
                            }
                        } else {
                            // Basic Heuristics if card not in DB
                            if (card.toLowerCase().includes("travel") && category === "Travel") { score = 2; reason = "Travel card guess"; }
                            else if (card.toLowerCase().includes("cash") && category === "Everything Else") { score = 1.5; reason = "Cash back guess"; }
                        }

                        if (score > maxScore) {
                            maxScore = score;
                            bestCard = card;
                            bestReason = reason;
                        }
                    });

                    newLogic[category] = { card: bestCard, reason: bestReason };
                });
                return newLogic;
            };

            const finishCardSelection = () => {
                if (selectedCards.length === 0) {
                    alert("Select at least one card.");
                    return;
                }
                setStep(4);
                addUserMessage(`${selectedCards.length} cards selected.`);
                addBotMessage("Analyzing wallet...");
                setTimeout(() => {
                    const generatedUiLogic = calculateBestLogic(selectedCards);
                    setUiCardLogic(generatedUiLogic);
                    setStep(5);
                    addBotMessage("Here is your Smart Pay strategy. Tap any card to change it.");
                }, 1500);
            };

            const updateLogic = (category, cardName) => {
                let reason = "1% base value"; // Default fallback
                const benefits = CARD_BENEFITS[cardName];
                
                if (benefits) {
                    if (benefits[category]) {
                        reason = benefits[category].reason;
                    } else if (benefits["Everything Else"]) {
                        reason = benefits["Everything Else"].reason;
                    }
                } else {
                    // Fallbacks for unknown cards
                    if (category === "Everything Else") reason = "Base reward";
                    else reason = "Base reward (fallback)";
                }

                setUiCardLogic(prev => ({
                    ...prev,
                    [category]: { card: cardName, reason: reason }
                }));
            };

            const generateDetailedRules = (uiLogic, cards) => {
                const rules = {};

                Object.entries(uiLogic).forEach(([category, data]) => {
                    const types = CATEGORY_TO_TYPES[category] || [];
                    types.forEach(type => {
                        // Strict requirement: Everything Else -> other -> match_on: default
                        let matchOn = "type";
                        if (type === "other") matchOn = "default";
                        
                        rules[type] = {
                            card: data.card,
                            reason: data.reason || `Best card for ${category}`,
                            match_on: matchOn
                        };
                    });
                });

                cards.forEach(card => {
                    if (card.includes("Prime Visa")) {
                        rules["Amazon"] = { card: card, reason: "5% cash back at Amazon", match_on: "name" };
                        rules["Whole Foods"] = { card: card, reason: "5% cash back at Whole Foods", match_on: "name" };
                    }
                    if (card.includes("Target RedCard")) {
                         rules["Target"] = { card: card, reason: "5% off at Target", match_on: "name" };
                    }
                });

                return rules;
            };

            const generateMailToLink = () => {
                const rulesTable = Object.entries(uiCardLogic).map(([cat, data]) => `- ${cat}: ${data.card} (${data.reason})`).join('\n');
                const subject = encodeURIComponent("Thanks for using Smart Pay!");
                const body = encodeURIComponent(`Smart Pay Setup\n\nUser: ${username}\n\nWallet:\n${selectedCards.join(', ')}\n\nLogic:\n${rulesTable}\n\nLink: https://www.icloud.com/shortcuts/088826c24ce642708a9227181686475b`);
                return `mailto:${email}?subject=${subject}&body=${body}`;
            };

            const confirmLogic = async () => {
                setStep(6);
                addUserMessage("Save it!");
                addBotMessage("Saving to cloud... ‚òÅÔ∏è");
                
                try {
                    const detailedRules = generateDetailedRules(uiCardLogic, selectedCards);
                    
                    // Add timestamp in UTC
                    detailedRules["last_updated"] = new Date().toISOString();
                    
                    const rulesFilename = `rules-${username}.json`;
                    const rulesContent = JSON.stringify(detailedRules, null, 2);
                    
                    const createGistResponse = await fetch("https://api.github.com/gists", {
                        method: "POST",
                        headers: { "Authorization": `token ${GITHUB_TOKEN}`, "Content-Type": "application/json" },
                        body: JSON.stringify({ description: `Smart Pay Rules for ${username}`, public: false, files: { [rulesFilename]: { content: rulesContent } } })
                    });

                    if (!createGistResponse.ok) throw new Error("Failed to create gist");
                    const rulesGistData = await createGistResponse.json();
                    const userRulesId = rulesGistData.id;

                    const getConfigResponse = await fetch(`https://api.github.com/gists/${CENTRAL_GIST_ID}`, {
                        headers: { "Authorization": `token ${GITHUB_TOKEN}` }
                    });
                    const configGistData = await getConfigResponse.json();
                    
                    let currentConfig = { users: {} };
                    try { currentConfig = JSON.parse(configGistData.files[CENTRAL_FILE_NAME].content); } catch (e) {}
                    if (!currentConfig.users) currentConfig.users = {};
                    
                    currentConfig.users[username] = { id_rules: userRulesId, email: email };

                    await fetch(`https://api.github.com/gists/${CENTRAL_GIST_ID}`, {
                        method: "PATCH",
                        headers: { "Authorization": `token ${GITHUB_TOKEN}`, "Content-Type": "application/json" },
                        body: JSON.stringify({ files: { [CENTRAL_FILE_NAME]: { content: JSON.stringify(currentConfig, null, 2) } } })
                    });

                    setStep(7);
                    addBotMessage("Saved! üéâ");

                } catch (error) {
                    addBotMessage("Error saving. Please retry.");
                }
            };

            return (
                <div className="flex flex-col h-screen max-w-lg mx-auto bg-ios-bg shadow-2xl overflow-hidden relative sm:rounded-xl sm:my-8 sm:h-[90vh] sm:border border-gray-200">
                    
                    {/* Header */}
                    <div className="bg-white/80 backdrop-blur-md border-b border-gray-200 p-4 flex items-center justify-between sticky top-0 z-20">
                        <h1 className="font-bold text-lg text-black mx-auto">Smart Pay</h1>
                    </div>

                    {/* Chat */}
                    <div className="flex-1 p-4 chat-container">
                        {messages.map((msg, idx) => (
                            <ChatBubble key={idx} sender={msg.sender}>{msg.text}</ChatBubble>
                        ))}
                        {isTyping && <TypingIndicator />}

                        {/* Card Selection UI */}
                        {step === 3 && !isTyping && (
                            <div className="mt-4 bg-white rounded-2xl p-4 shadow-sm fade-in mx-2">
                                <h3 className="font-semibold text-gray-900 mb-3 text-lg">Your Wallet</h3>
                                {/* Added pr-4 to prevent scrollbar overlap */}
                                <div className="space-y-0 divide-y divide-gray-100 mb-4 max-h-60 overflow-y-auto pr-4">
                                    {POPULAR_CARDS.map(card => (
                                        <label key={card} className="flex items-center justify-between py-3 cursor-pointer group">
                                            <span className="text-[15px] text-gray-800 mr-2">{card}</span>
                                            <input 
                                                type="checkbox" 
                                                className="w-5 h-5 rounded-full border-gray-300 text-ios-blue focus:ring-ios-blue ios-checkbox flex-shrink-0"
                                                checked={selectedCards.includes(card)}
                                                onChange={() => toggleCard(card)}
                                            />
                                        </label>
                                    ))}
                                </div>
                                <div className="flex gap-2 mb-4">
                                    <input 
                                        type="text" 
                                        placeholder="Search other cards..." 
                                        className="flex-1 bg-gray-100 rounded-xl px-4 py-2 text-[15px] outline-none focus:ring-2 focus:ring-ios-blue/20"
                                        value={otherCardInput}
                                        onChange={(e) => setOtherCardInput(e.target.value)}
                                        onKeyDown={(e) => e.key === 'Enter' && addOtherCard()}
                                    />
                                    <button onClick={addOtherCard} className="text-ios-blue font-semibold px-2">Add</button>
                                </div>
                                <button onClick={finishCardSelection} className="w-full bg-ios-blue text-white py-3 rounded-xl font-semibold text-[17px] active:opacity-90 transition-opacity">Continue</button>
                            </div>
                        )}

                        {/* Logic Editor UI */}
                        {step === 5 && !isTyping && (
                            <div className="mt-4 bg-white rounded-2xl overflow-hidden shadow-sm fade-in mx-2">
                                <div className="p-4 border-b border-gray-100">
                                    <h3 className="font-semibold text-gray-900 text-lg">Smart Rules</h3>
                                </div>
                                <div className="divide-y divide-gray-100">
                                    {Object.entries(uiCardLogic).map(([category, data]) => (
                                        <div key={category} className="p-4 flex flex-col gap-2">
                                            <div className="flex justify-between items-baseline">
                                                <span className="font-medium text-gray-900">{category}</span>
                                                <span className="text-xs text-ios-subtext font-medium">{data.reason}</span>
                                            </div>
                                            <select 
                                                className="w-full bg-gray-50 text-ios-blue font-medium p-2 rounded-lg text-[15px] outline-none"
                                                value={data.card}
                                                onChange={(e) => updateLogic(category, e.target.value)}
                                            >
                                                {selectedCards.map(card => (
                                                    <option key={card} value={card}>{card}</option>
                                                ))}
                                            </select>
                                        </div>
                                    ))}
                                </div>
                                <div className="p-4 bg-gray-50">
                                    <button onClick={confirmLogic} className="w-full bg-ios-green text-white py-3 rounded-xl font-semibold text-[17px] shadow-sm active:opacity-90">Confirm & Save</button>
                                </div>
                            </div>
                        )}

                        {/* Success UI */}
                        {step === 7 && !isTyping && (
                            <div className="mt-6 space-y-4 fade-in pb-10 px-2">
                                {/* Install Shortcut first */}
                                <div className="bg-white p-5 rounded-2xl shadow-sm">
                                    <div className="flex items-center mb-3">
                                        <div className="w-10 h-10 bg-ios-blue rounded-xl flex items-center justify-center text-white text-xl mr-3 shadow-sm">
                                            <i className="fas fa-bolt"></i>
                                        </div>
                                        <h4 className="font-bold text-gray-900 text-lg">Install Shortcut</h4>
                                    </div>
                                    
                                    <p className="text-[15px] text-gray-600 mb-4 leading-relaxed">
                                        1. Click "Get Shortcut" to install it on your phone. The Shortcuts app will open.<br/>
                                        2. In the Shortcuts app, go to <b>Library</b> (see "1" in the image below), and tap <b>"‚ö°Ô∏è Smart Pay"</b> (see "2") to complete the setup.
                                    </p>

                                    {/* Screenshot Placeholder */}
                                    <div className="mb-4 rounded-xl overflow-hidden border border-gray-100 shadow-sm w-3/4 mx-auto">
                                        <img 
                                            src="https://github.com/pedroeisner/smartpay-public/blob/main/images/shortcut-location-screenshot.png?raw=true" 
                                            alt="Shortcuts App Screenshot showing Library tab (1) and Smart Pay shortcut (2)" 
                                            className="w-full h-auto object-cover"
                                        />
                                    </div>

                                    <a href="https://www.icloud.com/shortcuts/088826c24ce642708a9227181686475b" target="_blank" className="block w-full text-center bg-ios-blue text-white py-3.5 rounded-xl font-bold text-[17px] shadow-md active:opacity-90">
                                        Get Shortcut
                                    </a>
                                </div>

                                {/* Email second */}
                                <a href={generateMailToLink()} target="_blank" className="block w-full text-center bg-white text-ios-blue py-3.5 rounded-xl font-semibold text-[17px] shadow-sm active:bg-gray-50">
                                    <i className="fas fa-envelope mr-2"></i> Send Backup Email
                                </a>
                            </div>
                        )}
                        <div ref={chatEndRef} />
                    </div>

                    {/* Input Area */}
                    {(step === 1 || step === 2) && (
                        <div className="p-3 bg-gray-100 border-t border-gray-200">
                            <div className="flex items-center bg-white rounded-full px-4 py-2 border border-gray-300 focus-within:border-ios-blue focus-within:ring-1 focus-within:ring-ios-blue transition-all">
                                <input
                                    type="text"
                                    className="flex-1 bg-transparent border-none outline-none text-[17px] placeholder-gray-400 h-8"
                                    placeholder="Type here..."
                                    value={inputText}
                                    onChange={(e) => setInputText(e.target.value)}
                                    onKeyDown={(e) => e.key === 'Enter' && handleSend()}
                                    autoFocus
                                />
                                <button 
                                    onClick={handleSend} 
                                    disabled={!inputText.trim()}
                                    className={`ml-2 w-8 h-8 rounded-full flex items-center justify-center transition-colors ${inputText.trim() ? 'bg-ios-blue text-white' : 'bg-gray-200 text-gray-400'}`}
                                >
                                    <i className="fas fa-arrow-up text-sm"></i>
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
